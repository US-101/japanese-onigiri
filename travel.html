<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>日語飯糰｜旅行會話</title><link rel="manifest" href="manifest.json"><link rel="stylesheet" href="styles.css">
<link rel="apple-touch-icon" href="icons/icon-512.png"><script>if('serviceWorker' in navigator){addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));}</script></head><body>
<header class="topbar"><div class="bar"><h1 class="title"><img src="icons/p2.svg" alt=""></h1></div></header>
<div class="appbar"><div class="row" style="justify-content:space-between;gap:12px;max-width:540px;margin:0 auto;padding:12px 16px 6px 16px">
  <div style="display:flex;gap:12px">
    <span id="voiceJa" class="pill">蛋捲</span>
    <span id="voiceEn" class="pill">Moira</span>
    <span id="mickey" class="pill"><img src="icons/micky.svg" width="20" height="20" alt=""></span>
  </div>
  <span class="pill amber speed">x0.75</span>
</div>
<div class="tabs"><button class="tab active" data-tab="R">餐廳</button><button class="tab" data-tab="S">購物</button><button class="tab" data-tab="N">問路</button><button class="tab" data-tab="O">其他</button></div></div>
<main class="wrap"><div id="cards" class="list"></div></main>
<nav class="tabbar"><div class="in"><a class='' href='index.html'><span class='ico'><img src='icons/p1.svg' alt=''></span>發音練習</a><a class='active' href='travel.html'><span class='ico'><img src='icons/p2.svg' alt=''></span>旅行會話</a><a class='' href='translate.html'><span class='ico'><img src='icons/p3.svg' alt=''></span>實時翻譯</a><a class='' href='history.html'><span class='ico'><img src='icons/p4.svg' alt=''></span>歷史紀錄</a></div></nav>

<!-- 確認刪除彈窗 -->
<section class="modal" id="confirmDelete" style="display:none"><div class="sheet">
  <button class="close" id="confirmClose" aria-label="關閉">✕</button>
  <h3 class="title" style="text-align:center;margin:6px 0 12px 0;color:#78bfc0">確定要從收藏移除嗎？</h3>
  <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
    <button class="pill" id="confirmYes">確 定</button>
    <button class="pill" id="confirmNo">取 消</button>
  </div>
</div></section>
<script>
const EN=["Daniel","Moira","Samantha","Tessa"];
let RATE=0.75; const SPEEDS=[0.5,0.75,1.0];
let VOICE_EN_NAME = localStorage.getItem('voiceEnName') || 'Moira';
function updateVoiceUI(){ const el=document.getElementById('voiceEn'); if(el) el.textContent = VOICE_EN_NAME; }
function availableEnVoices(){ const all=speechSynthesis.getVoices(); return EN.map(n=>all.find(v=>v.name===n)).filter(Boolean); }
function ensureVoice(){ const avail=availableEnVoices().map(v=>v.name); if(!avail.includes(VOICE_EN_NAME) && avail.length){ VOICE_EN_NAME = avail[0]; localStorage.setItem('voiceEnName', VOICE_EN_NAME); }
  updateVoiceUI(); }
function cycleVoice(){ const avail=availableEnVoices().map(v=>v.name); if(!avail.length) return; const idx=avail.indexOf(VOICE_EN_NAME); VOICE_EN_NAME = avail[(idx+1)%avail.length]; localStorage.setItem('voiceEnName', VOICE_EN_NAME); updateVoiceUI(); }
function updateSpeedUI(){ document.querySelectorAll('.speed').forEach(el=>{ el.textContent='x'+RATE.toFixed(2).replace(/\.00$/,''); }); }
function cycleSpeed(){ const i=SPEEDS.indexOf(RATE); RATE=SPEEDS[(i+1)%SPEEDS.length]; updateSpeedUI(); }
function loadEn(){ const all=speechSynthesis.getVoices(); const sel=document.getElementById('voiceEn'); const picked=EN.map(n=>all.find(v=>v.name===n)).filter(Boolean); if(picked.length){ sel.innerHTML=picked.map(v=>`<option>${v.name}</option>`).join(""); const saved=localStorage.getItem('voiceEnName'); if(saved&&picked.some(v=>v.name===saved)) sel.value=saved; sel.addEventListener('change',()=>localStorage.setItem('voiceEnName', sel.value)); } }
window.speechSynthesis.onvoiceschanged = ()=>{ ensureVoice(); };
document.getElementById('mickey').addEventListener('click',e=>e.currentTarget.classList.toggle('on'));

const DATA={R:[
  ["お勧めは何ですか？","What do you recommend?","有什麼推薦的嗎？"],
  ["辛くない物にしてください。","Please make it less spicy.","可以做不辣的嗎？"],
  ["お会計は別々にしてください。","Could we split the bill?","請分開結帳。"],
  ["カードで払えますか？","Can I pay with card?","可以刷卡嗎？"]
],S:[
  ["他の色はありますか？","Do you have this in other colors?","這個有別的顏色嗎？"],
  ["S、M、Lサイズはありますか？","Do you have this in S, M, or L?","這個有沒有 S、M、L 的尺寸？"],
  ["試着してもいいですか？","May I try it on?","可以試穿嗎？"],
  ["これは幾らですか？割引はありますか？","How much is this? Any discount?","這個多少錢？有折扣嗎？"]
],N:[
  ["この写真の場所はどこですか？","Where is this place in the photo?","這張照片裡的地方在哪裡？"],
  ["ここへはどう行けばいいですか？","How do I get here?","要到這裡怎麼走？"],
  ["右/左/真っ直ぐ行ってください。","Go right/left/straight.","往右/往左/直走。"],
  ["すみません、道を教えてください。","Excuse me, can you tell me the way?","不好意思，可以告訴我路怎麼走嗎？"]
],O:[
  ["大丈夫です。","It's okay.","沒關係。"],["有難うございます。","Thank you.","謝謝。"],
  ["すみません。","Excuse me.","不好意思。"],["助けてください。","Please help me.","請幫幫我。"]
]};

// === Japanese Voice Whitelist: 只保留 Kyoko (蛋捲) & 模擬太郎 ===
const JA_LABELS = [
  { label: '蛋捲', names: ['Kyoko'] },   // 正常女聲
  { label: '太郎', names: ['Kyoko'] }    // 模擬男聲（通過參數調整）
];

// 使用者選擇 (UI 顯示用)，預設蛋捲
let VOICE_JA_LABEL = localStorage.getItem('voiceJaName') || '蛋捲';

// 找出目前系統有哪些可用的日文 voice
function availableJaVoices() {
  const all = speechSynthesis.getVoices();
  const out = [];
  for (const item of JA_LABELS) {
    const v = all.find(x =>
      /ja/i.test(x.lang || '') &&
      item.names.some(n => (x.name || '').toLowerCase().includes(n.toLowerCase()))
    );
    out.push({ label: item.label, voice: v || null });
  }
  return out;
}

// 不改 UI，只回傳實際能用的 voice，否則 fallback
function resolveJaVoiceSoft() {
  const all = speechSynthesis.getVoices();
  // 找目前選的
  const picked = JA_LABELS.find(x => x.label === VOICE_JA_LABEL);
  if (picked) {
    const v = all.find(x =>
      /ja/i.test(x.lang || '') &&
      picked.names.some(n => (x.name || '').toLowerCase().includes(n.toLowerCase()))
    );
    if (v) return v;
  }
  // fallback: 第一個能用的
  for (const item of JA_LABELS) {
    const v = all.find(x =>
      /ja/i.test(x.lang || '') &&
      item.names.some(n => (x.name || '').toLowerCase().includes(n.toLowerCase()))
    );
    if (v) return v;
  }
  return null;
}

// 更新 UI 按鈕文字
function updateJaVoiceUI() {
  const el = document.getElementById('voiceJa');
  if (el) el.textContent = VOICE_JA_LABEL;
}

// 點擊切換 (兩個之間輪流)
function cycleJaVoice() {
  const labels = JA_LABELS.map(x => x.label);
  const idx = labels.indexOf(VOICE_JA_LABEL);
  VOICE_JA_LABEL = labels[(idx + 1) % labels.length];
  localStorage.setItem('voiceJaName', VOICE_JA_LABEL);
  updateJaVoiceUI();
}

// 初始化：在 voices ready 時更新 UI
window.speechSynthesis.onvoiceschanged = () => {
  resolveJaVoiceSoft();
  updateJaVoiceUI();
};

// 注意：不再修改 VOICE_JA_LABEL（不回跳 UI）
function speakJA(t){ 
  const correctedText = (t||'').replace(/行って/g, 'いって');
  const u=new SpeechSynthesisUtterance(correctedText);
  u.lang='ja-JP';
  
  const v = resolveJaVoiceSoft();
  if (v) u.voice = v;

  // 語速基準
  const baseRate = (typeof RATE === 'number' ? RATE : 0.75);

  if (VOICE_JA_LABEL === '蛋捲') {
    // 正常女聲
    u.rate = baseRate;
    u.pitch = 1.0;
    u.volume = 1.0;
  } else if (VOICE_JA_LABEL === '太郎') {
    // 搞怪男聲（神經質、像米奇）
    u.rate = Math.min(baseRate * 1.5, 1.6);  // 更快一點
    u.pitch = 1.8;                           // 更高音
    u.volume = 1.0;                          // 正常音量
  }

  speechSynthesis.speak(u);
} 
function speakEN(t){ const v=speechSynthesis.getVoices().find(v=>v.name===VOICE_EN_NAME)||speechSynthesis.getVoices().find(v=>/en/i.test(v.lang||'')); const u=new SpeechSynthesisUtterance(t); if(v) u.voice=v; u.rate=RATE; if(document.getElementById('mickey').classList.contains('on')) u.pitch=1.6; speechSynthesis.speak(u);}

function formatWord(ja){
  // 1) 沒有漢字：不標
  const hasKanji = /[\u4E00-\u9FFF]/.test(ja);
  if (!hasKanji) return ja;

  // 已經有 ruby 就不重複
  if (ja.includes('<ruby>')) return ja;

  // 完整的詞彙映射表
  const wordMap = [
    // 完整詞彙（優先匹配）
    { from: "携帯電話番号", to: "けいたいでんわばんごう" },
    { from: "携帯電話", to: "けいたいでんわ" },
    { from: "真っ直ぐ", to: "まっすぐ" },
    { from: "大丈夫", to: "だいじょうぶ" },
    { from: "有難う", to: "ありがとう" },
    { from: "有難うございます", to: "ありがとうございます" },
    { from: "有難", to: "ありが" },
    { from: "助けて", to: "たすけて" },
    { from: "辛くない", to: "からくない" },
    { from: "物", to: "もの" },
    { from: "お勧め", to: "おすすめ" },
    { from: "会計", to: "かいけい" },
    { from: "別々", to: "べつべつ" },
    { from: "試着", to: "しちゃく" },
    { from: "幾ら", to: "いくら" },
    { from: "割引", to: "わりびき" },
    { from: "写真", to: "しゃしん" },
    { from: "場所", to: "ばしょ" },
    { from: "場合", to: "ばあい" },
    { from: "行って", to: "いって" },
    
    // 部分詞彙（次優先）
    { from: "携帯", to: "けいたい" },
    { from: "電話", to: "でんわ" },
    { from: "番号", to: "ばんごう" },
    { from: "入力", to: "にゅうりょく" },
    
    // 單字（最後處理）
    { from: "何", to: "なに" },
    { from: "物", to: "もの" },
    { from: "払", to: "はら" },
    { from: "辛", to: "から" },
    { from: "他", to: "ほか" },
    { from: "色", to: "いろ" },
    { from: "右", to: "みぎ" },
    { from: "左", to: "ひだり" },
    { from: "道", to: "みち" },
    { from: "教", to: "おし" },
    { from: "食", to: "た" },
    { from: "持", to: "も" },
    { from: "携", to: "けい" },
    { from: "帯", to: "たい" },
    { from: "電", to: "でん" },
    { from: "話", to: "わ" },
    { from: "番", to: "ばん" },
    { from: "号", to: "ごう" },
    { from: "入", to: "にゅう" },
    { from: "力", to: "りょく" },
    { from: "直", to: "す" },
    { from: "行", to: "い" },
    { from: "真", to: "ま" },
    { from: "直ぐ", to: "すぐ" },
    { from: "勧", to: "すす" },
    { from: "計", to: "けい" },
    { from: "別", to: "べつ" },
    { from: "試", to: "し" },
    { from: "着", to: "ちゃく" },
    { from: "幾", to: "いく" },
    { from: "割", to: "わり" },
    { from: "引", to: "びき" },
    { from: "写", to: "しゃ" },
    { from: "場", to: "ば" },
    { from: "所", to: "しょ" },
    { from: "合", to: "あい" },
    { from: "助", to: "たす" },
    { from: "難", to: "がた" },
    { from: "大", to: "だい" },
    { from: "丈", to: "じょう" },
    { from: "夫", to: "ぶ" },
    { from: "人", to: "じん" },
    { from: "店", to: "みせ" },
    { from: "屋", to: "や" },
    { from: "者", to: "しゃ" },
    { from: "物", to: "もの" },
    { from: "事", to: "こと" },
    { from: "時", to: "とき" },
    { from: "所", to: "ところ" },
    { from: "方", to: "かた" },
    { from: "中", to: "なか" },
    { from: "上", to: "うえ" },
    { from: "下", to: "した" },
    { from: "前", to: "まえ" },
    { from: "後", to: "あと" },
    { from: "年", to: "ねん" },
    { from: "月", to: "つき" },
    { from: "日", to: "ひ" },
    { from: "今", to: "いま" },
    { from: "今", to: "こん" },
    { from: "今", to: "きん" }
  ];

  function buildReadingFromMap(s){
    // 先整詞找最長匹配
    const sorted = [...wordMap].sort((a,b)=>b.from.length-a.from.length);
    const hit = sorted.find(w => w.from === s);
    if(hit) return hit.to;

    // 只對漢字進行單字處理，假名保持原樣
    return s.split('').map(ch=>{
      // 如果是漢字，才查找映射
      if (/[\u4E00-\u9FFF]/.test(ch)) {
        const m = wordMap.find(w=>w.from===ch);
        return m ? m.to : ch;
      }
      // 假名直接返回
      return ch;
    }).join('');
  }

  // 先嘗試取整詞讀音提示
  const readingAll = buildReadingFromMap(ja);

  // 2) 動詞/形容詞等「尾碼假名」處理：只給前面的漢字上 ruby
  const suffix = ja.match(/[ぁ-ゖー]+$/);      // 尾端平假名（送り仮名）
  if (suffix){
    const kanaSuffix = suffix[0];
    if (readingAll && readingAll.endsWith(kanaSuffix)){
      const baseKanji = ja.slice(0, -kanaSuffix.length);
      const baseReading = readingAll.slice(0, -kanaSuffix.length);
      return `<ruby>${baseKanji}<rt>${baseReading}</rt></ruby>${kanaSuffix}`;
    }
  }

  // 3) 其它混合情境（片假名 + 漢字 等）：僅對「連續漢字段」加 ruby
  return ja.replace(/([\u4E00-\u9FFF]+)/g, seg=>{
    const yomi = buildReadingFromMap(seg);
    // 只有當 yomi 不是原字且是平假名時才標註
    if (yomi && yomi !== seg && /^[\u3041-\u309F]+$/.test(yomi)) {
      return `<ruby>${seg}<rt>${yomi}</rt></ruby>`;
    }
    return seg;
  });
} 

function cardBase([ja,en,zh]){ const d=document.createElement('div'); d.className='card'; d.innerHTML=`<div class='card-inner'><div class='ko' data-original='${ja}'>${formatWord(ja)}</div><div class='trans'><div class='en'>${en}</div><div class='zh'>${zh}</div></div><div class='act'><button class='pill' data-ja='${ja}'>日</button><button class='pill' data-en='${en}'>英</button></div></div>`; return d; }
function cardFav(f){ const d=document.createElement('div'); d.className='card'; d.innerHTML=`<div class='card-inner'><div class='ko' data-original='${f.ja}'>${formatWord(f.ja)}</div><div class='trans'><div class='en'>${f.en}</div><div class='zh'>${f.zh}</div></div><div class='act'><button class='pill' data-ja='${f.ja}'>日</button><button class='pill' data-en='${f.en}'>英</button><span class='star on' data-fav='1' title='已收藏'><img src='icons/onigiri-yellow.svg' alt='已收藏' /></span></div></div>`; return d; }
function favs(){ try{ return JSON.parse(localStorage.getItem('japanese-favorites')||'[]'); }catch(e){ return []; } }
function render(cat){ const box=document.getElementById('cards'); box.innerHTML=''; (DATA[cat]||[]).forEach(x=>box.appendChild(cardBase(x)));
  // append favorites that belong to this folder name
  const folderName = document.querySelector('.tab.active')?.textContent || (cat==='R'?'餐廳':cat==='S'?'購物':cat==='N'?'問路':'其他');
  favs().filter(f=>f.folder===folderName).forEach(f=>{ box.appendChild(cardFav(f)); }); }
let PENDING_DELETE = null;

// 處理複製事件，確保複製的是純文字版本
document.addEventListener('copy', e => {
  const selection = window.getSelection();
  if (selection.rangeCount > 0) {
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    const koElement = container.nodeType === Node.TEXT_NODE ? 
      container.parentElement.closest('.ko') : 
      container.closest('.ko');
    
    if (koElement && koElement.hasAttribute('data-original')) {
      e.preventDefault();
      const originalText = koElement.getAttribute('data-original');
      e.clipboardData.setData('text/plain', originalText);
    }
  }
});

document.addEventListener('click',e=>{ 
  if(e.target.closest('#voiceEn')) return cycleVoice(); 
  if(e.target.closest('.speed')) return cycleSpeed(); 
  if(e.target.matches('[data-ja]')){ 
    e.target.classList.add('pulse','amber-temp'); 
    setTimeout(()=>e.target.classList.remove('pulse','amber-temp'),350); 
    return speakJA(e.target.getAttribute('data-ja')); 
  } 
  if(e.target.matches('[data-en]')){ 
    e.target.classList.add('pulse','amber-temp'); 
    setTimeout(()=>e.target.classList.remove('pulse','amber-temp'),350); 
    return speakEN(e.target.getAttribute('data-en')); 
  } 
  if(e.target.classList.contains('tab')){ 
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); 
    e.target.classList.add('active'); 
    render(e.target.getAttribute('data-tab')); 
    return; 
  } 
  if(e.target.classList.contains('star') || e.target.closest('.star')){ 
    const starEl = e.target.closest('.star') || e.target;
    const c=starEl.closest('.card'); 
    const folder=document.querySelector('.tab.active').textContent; 
    const ja=c.querySelector('.ko').textContent; 
    const en=c.querySelector('.en').textContent; 
    const zh=c.querySelector('.zh').textContent; 
    if(starEl.hasAttribute('data-fav')){ 
      PENDING_DELETE = {ja, en, zh, folder, el: starEl};
      document.getElementById('confirmDelete').style.display='flex'; 
      return; 
    } 
  } 
  
  // 確認刪除彈窗處理
  if(e.target.id==='confirmYes' && PENDING_DELETE){ 
    const list=favs().filter(x=>!(x.ja===PENDING_DELETE.ja && x.en===PENDING_DELETE.en && x.zh===PENDING_DELETE.zh && x.folder===PENDING_DELETE.folder)); 
    localStorage.setItem('japanese-favorites', JSON.stringify(list)); 
    render(document.querySelector('.tab.active')?.getAttribute('data-tab')||'R'); 
    PENDING_DELETE = null;
    document.getElementById('confirmDelete').style.display='none'; 
    return; 
  }
  
  if(e.target.id==='confirmNo' || e.target.id==='confirmClose'){ 
    PENDING_DELETE = null;
    document.getElementById('confirmDelete').style.display='none'; 
    return; 
  }
  
  // 點擊彈窗背景關閉
  if(e.target.id==='confirmDelete') { 
    PENDING_DELETE = null;
    document.getElementById('confirmDelete').style.display='none'; 
    return; 
  }
});
ensureVoice(); updateSpeedUI();
updateSpeedUI();
render("R");

// 強制初始化日文語音按鈕（延遲執行確保 voices 準備好）
setTimeout(() => {
  const voiceJaEl = document.getElementById('voiceJa');
  if (voiceJaEl && !voiceJaEl.hasAttribute('data-initialized')) {
    voiceJaEl.addEventListener('click', cycleJaVoice);
    voiceJaEl.setAttribute('data-initialized', 'true');
    updateJaVoiceUI();
    console.log('Japanese voice button force initialized');
    
    // 測試可用聲音
    const avail = availableJaVoices();
    console.log('Available Japanese voices:', avail);
    
    // 顯示所有系統日文聲音供調試
    const allVoices = speechSynthesis.getVoices();
    const allJaVoices = allVoices.filter(v => /ja/i.test(v.lang || ''));
    console.log('All system Japanese voices:', allJaVoices.map(v => ({name: v.name, lang: v.lang})));
  }
}, 1000);
</script></body></html>
