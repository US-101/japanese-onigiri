:root{--bg:#F3FCFD;--card:#fff;--ink:#2b2f33;--muted:#8b8f94;--line:#e9eef2;--teal:#8ECFD0;--amber:#FAD162;--shadow:0 6px 18px rgba(40,48,54,.08),0 1px 3px rgba(40,48,54,.05);}*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-rounded,ui-sans-serif,-apple-system,'Noto Sans TC','PingFang TC','Microsoft JhengHei',sans-serif;padding-top:72px}

/* 頂列（固定在最上、層級最高） */
.topbar{position:fixed;top:0;left:0;right:0;z-index:2000;background:var(--bg)}
.topbar .bar{background:var(--bg);padding:14px 16px;border-bottom:1px solid var(--line)}
.topbar .title{text-align:center;margin:0;letter-spacing:0;color:#78bfc0;font-weight:700;display:flex;align-items:center;justify-content:center;min-height:44px}
.topbar .title img{width:44px;height:44px;display:block;filter:invert(79%) sepia(14%) saturate(1036%) hue-rotate(130deg) brightness(92%) contrast(88%)}

/* 次頂列（貼齊 topbar 下緣 72px，不再頂到最上面） */
.appbar{position:sticky;top:72px;z-index:95;background:var(--bg)}
.appbar .bar{background:var(--bg);padding:14px 16px;border-bottom:1px solid var(--line)}
.appbar .title{text-align:center;margin:0;letter-spacing:0;color:#78bfc0;font-weight:700;display:flex;align-items:center;justify-content:center;min-height:32px}
.appbar .row{display:flex;align-items:center;gap:10px;justify-content:center;padding:12px 16px 6px 16px}

/* 可能存在的次級固定列（維持原本貼齊 topbar） */
.subbar{position:fixed;left:0;right:0;top:72px;background:var(--bg);z-index:85;border-bottom:1px solid var(--line)}
.has-subbar .wrap{padding-top:116px}

/* 膠囊按鈕（全域預設） */
.pill{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:1.5px solid var(--teal);background:#fff;color:var(--teal);box-shadow:var(--shadow);cursor:pointer}
.pill.teal{background:var(--teal);color:#fff;border-color:var(--teal)}
.pill.amber{background:var(--amber);color:#7a5b00;border-color:var(--amber)}
.pill .dot{width:6px;height:6px;background:#fff;border-radius:999px;display:inline-block}
/* 讓 appbar 的「母音 / 子音 / 0.75」尺寸一致 */
.appbar .pill{height:40px;padding:0 16px;border-radius:999px;display:inline-flex;align-items:center;font-size:16px;line-height:1}

/* transient amber state */
.amber-temp{background:var(--amber)!important;color:#7a5b00!important;border-color:var(--amber)!important}

.wrap{max-width:540px;margin:0 auto;padding:12px 16px 110px 16px;scroll-margin-top:72px}

.grid{display:grid;gap:16px;grid-template-columns:repeat(5,1fr)}
.tile{background:#fff;border-radius:18px;padding:22px 10px;text-align:center;box-shadow:var(--shadow)}
.tile .sym{font-size:34px;font-weight:800;color:#3e4246;letter-spacing:2px}
.tile .rom{font-size:12px;color:var(--muted);margin-top:6px}

/* 詳細頁／彈窗 */
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(243,252,253,.95);display:none;z-index:2000}
.sheet{max-width:540px;margin:0 auto;padding:14px 16px 96px 16px;position:relative}

/* 返回上一頁：層級提高，確保可點擊 */
.backbtn{width:48px;height:48px;border-radius:16px;background:var(--teal);color:#fff;border:none;display:inline-flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer;position:relative;z-index:2100;pointer-events:auto}

/* 大母音框：改為圓角方形，並避免遮擋點擊 */
.speed{margin-left:auto}
.big{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:32px;margin:16px 0 24px 0;width:140px;height:140px;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer}
.big span{font-size:56px;color:#78bfc0;font-weight:800}

/* 單字卡片 */
.word{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:12px 16px;margin-top:14px;display:flex;align-items:center;gap:16px}
.word .ko{font-weight:800;font-size:22px;color:#8ECFD0;position:relative;padding-top:12px}
.word .ko ruby{font-size:22px;color:#8ECFD0}
.word .ko rt{font-size:12px;color:#8ECFD0;font-weight:400;user-select:none}
.word .zh{font-size:14px;color:var(--ink);margin-bottom:4px}
.word .desc{font-size:12px;color:var(--muted);letter-spacing:2px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:12px;background:#fff;border:1px solid var(--line);cursor:pointer}

/* Translate CTA feedback */
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
.pill.pulse{animation:pulse .35s ease-out}
.pill.busy{opacity:.9;pointer-events:none}
@keyframes flash{0%{background:#fffbe6}100%{background:#fff}}
.card.flash{animation:flash .8s ease-out 1}

/* Small spinner for loading */
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:16px;height:16px;border:2px solid #e9eef2;border-top-color:#8ECFD0;border-radius:50%;display:inline-block;animation:spin .7s linear infinite;vertical-align:middle}

/* Badge pulse for KO/EN click */
.badge.pulse{animation:pulse .35s ease-out}

/* 分頁籤 */
.tabs{display:flex;gap:18px;justify-content:center;margin-top:6px}
.tab{border:none;background:transparent;color:#7c8b8c;cursor:pointer;position:relative;padding:12px 4px;font-size:18px}
.tab.active{color:#78bfc0}
.tab + .tab::before{content:'';position:absolute;left:-9px;top:50%;transform:translateY(-50%);width:1px;height:14px;background:#cbd5d6}

/* 列表卡 */
.list{display:flex;flex-direction:column;gap:14px;margin-top:14px}
.card{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:14px 16px;position:relative}
.card .ko{font-weight:800;word-wrap:break-word;overflow-wrap:break-word;max-width:calc(100% - 120px);line-height:1.4;position:relative;padding-top:12px}
.card .ko ruby{font-size:16px}
.card .ko rt{font-size:10px;color:#2b2f33;font-weight:400;user-select:none}
.card .en{font-size:13px;color:#5a6166;margin-top:6px}
.card .zh{font-size:12px;color:#97a1a6}
.badges{position:absolute;top:14px;right:16px;display:flex;gap:6px;align-items:center}
.badge{background:#f0fbfb;border:1px solid #d6efef;color:#6aa;padding:6px 8px;border-radius:999px;font-size:12px}
.star{cursor:pointer;font-size:18px;color:#c3ccd0}
.star.on{color:#f5c14a}
.star img{width:18px;height:18px;display:block;opacity:.9;filter:grayscale(100%) brightness(0) invert(70%)}
.star.on img{opacity:1;filter:none}

/* 輸入框 */
textarea{width:100%;min-height:120px;border:2px solid #cfe7e7;border-radius:14px;padding:12px;font-size:15px;background:#fff}

/* 底部導覽列 */
.tabbar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);z-index:3000}
.tabbar .in{max-width:540px;margin:0 auto;display:grid;grid-template-columns:repeat(4,1fr)}
.tabbar a{padding:12px 8px 24px;text-align:center;color:#9aa3a8;font-size:11px;text-decoration:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;line-height:1;min-height:72px}
.tabbar a .ico{display:flex;align-items:center;justify-content:center;margin:0}
.tabbar a.active{color:#8ECFD0}
.tabbar a .ico{width:22px;height:22px}
/* 顯示 <img> 並用濾鏡調整顏色，避免遮罩導致看不到 */
.tabbar a .ico img{width:22px;height:22px;display:block;opacity:.9;filter:grayscale(100%) brightness(0) invert(70%)}
.tabbar a.active .ico img{opacity:1;filter:invert(79%) sepia(14%) saturate(1036%) hue-rotate(130deg) brightness(92%) contrast(88%)}

/* Mickey 開關樣式：無邊框、預設灰、啟用為 #8ECFD0 */
#mickey{border:none;background:transparent;box-shadow:none;cursor:pointer;padding:8px 10px}
#mickey img{display:block;width:32px;height:32px;opacity:.9;filter:grayscale(100%) brightness(0) invert(70%)}
#mickey.on img{opacity:1;filter:invert(79%) sepia(14%) saturate(1036%) hue-rotate(130deg) brightness(92%) contrast(88%)}

/* 詳細頁播放按鈕：icon 顏色為 #8ECFD0，按下短暫變 #FAD162 */
.modal .btn{border:1px solid transparent;background:transparent;color:#8ECFD0}
.modal .btn svg{display:block}
.ink-amber{color:#FAD162!important}

/* 收藏彈窗置中 - 統一樣式 */
#pickFolder, #pickFolderH, #confirmDelete{
  display:none;
  align-items:center;
  justify-content:center;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.3);
  z-index:3000;
}
#pickFolder .sheet, #pickFolderH .sheet, #confirmDelete .sheet{
  background:rgba(255,255,255,.98);
  border-radius:20px;
  box-shadow:var(--shadow);
  padding:16px;
  position:relative;
  max-width:320px;
  width:90%;
}
#pickFolder .title, #pickFolderH .title, #confirmDelete .title{color:#78bfc0!important}
#pickFolder .pill, #pickFolderH .pill, #confirmDelete .pill{border-color:#e6ecef;color:#9aa3a8;background:#fff}
#pickFolder .pill:active, #pickFolderH .pill:active, #confirmDelete .pill:active{background:#8ECFD0;color:#fff;border-color:#8ECFD0}

/* 關閉按鈕 - 放大一倍 */
#pickFolder .close, #pickFolderH .close, #confirmDelete .close{
  position:absolute;
  top:8px;
  right:8px;
  border:none;
  background:transparent;
  color:#9aa3a8;
  cursor:pointer;
  padding:8px;
  border-radius:8px;
  font-size:24px;
  line-height:1;
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
}
#pickFolder .close:hover, #pickFolderH .close:hover, #confirmDelete .close:hover{
  background:#f3f6f8;
}

/* === Kana grid spacing tuning (small screens) === */
@media (max-width: 420px){
  .appbar .row{ padding: 6px 16px 2px 16px; }     /* 原本 12px/6px */
  .wrap{ padding: 8px 16px 96px 16px; }           /* 原本 12px top */
  .grid{ gap: 12px; }                             /* 原本 16px */
  .tile{ padding: 14px 10px; }                    /* 原本 22px 10px */
  .big{ margin: 10px 0 16px 0; }                  /* 詳細頁大字區塊稍微收緊 */
}

/* === Travel cards: prevent buttons covering text === */
#cards .card{ 
  display:grid; 
  grid-template-columns: minmax(0,1fr) auto; 
  column-gap:12px; 
  align-items:start;
}
#cards .card .text{ min-width:0; }

/* === CJK / EN 不同換行策略 === */
/* 旅行會話卡片內的日文（避免醜斷行） */
#cards .card .ko{
  word-break: keep-all;        /* 不在任意字元拆開（適合日文/中文） */
  overflow-wrap: normal;       /* 取消 anywhere，避免奇怪的位置換行 */
  line-break: strict;          /* CJK 嚴格換行規則 */
  -webkit-line-break: strict;  /* Safari 補強 */
  text-wrap: pretty;           /* 新版瀏覽器：更漂亮的標點/禁則處理 */
  hanging-punctuation: allow-end;
  letter-spacing: 0.01em;
  line-height: 1.7;
}

/* 如瀏覽器支援 balance，標題式句子更平均（不會單獨掉字） */
@supports (text-wrap: balance){
  #cards .card .ko{ text-wrap: balance; }
}

/* 英文可在必要時斷字，不影響日文 */
#cards .card .en{
  overflow-wrap: anywhere;
  hyphens: auto;
  line-height: 1.5;
}

/* 中文可與日文相同策略（可選） */
#cards .card .zh{
  word-break: keep-all;
  overflow-wrap: normal;
  line-break: strict;
  -webkit-line-break: strict;
  text-wrap: pretty;
  line-height: 1.6;
}

#cards .card .actions{ display:flex; gap:8px; align-self:start; }

/* 小螢幕：按鈕自動掉到下一行，避免遮擋 */
@media (max-width: 380px){
  #cards .card{ grid-template-columns: 1fr; }
  #cards .card .actions{ margin-top:6px; justify-content:flex-start; }
}

/* 手機寬度微調：給句子多一點寬度 */
@media (max-width: 400px){
  #cards .card{ padding: 12px 14px; } /* 原本 14px 16px */
}

/* ====== CJK/EN line wrapping (travel cards) ====== */
#cards .card .ja{
  word-break: keep-all;
  overflow-wrap: normal;
  line-break: strict;
  -webkit-line-break: strict;
  text-wrap: balance;
  line-height: 1.7;
  letter-spacing: .01em;
}
@supports not (text-wrap: balance){
  #cards .card .ja{ text-wrap: pretty; }
}
#cards .card .zh{
  word-break: keep-all;
  overflow-wrap: normal;
  line-break: strict;
  -webkit-line-break: strict;
  text-wrap: pretty;
  line-height: 1.6;
}
#cards .card .en{
  overflow-wrap: anywhere;
  hyphens: auto;
  line-height: 1.5;
}

/* ====== Buttons never cover text (travel cards) ====== */
#cards .card{
  display: grid;
  grid-template-columns: minmax(0,1fr) auto;
  align-items: start;
  column-gap: 12px;
}
#cards .card .text{ min-width: 0; }        /* 讓文字區能收縮 */
#cards .card .actions{
  display: flex;
  gap: 8px;
  align-self: start;
  position: static !important;             /* 強制不是絕對定位 */
}
@media (max-width: 380px){
  #cards .card{ grid-template-columns: 1fr; }
  #cards .card .actions{ margin-top: 6px; }
}

/* 小螢幕卡片左右留白微縮，讓句子更寬 */
@media (max-width: 420px){
  #cards .card{ padding: 12px 14px; }
}

/* ====== Bottom tab bar fixed & safe area ====== */
:root{ --tabbar-h: 68px; }

.tabbar{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  height: var(--tabbar-h);
  z-index: 1000;
  backdrop-filter: saturate(180%) blur(8px);
}
.tabbar .in{ height: 100%; }

/* 主要內容底部留出空間（含安全區） */
.wrap{
  padding-bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom, 0px) + 16px);
}

/* 有些頁面主體不是 .wrap 的，保底處理 */
main{ padding-bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom, 0px) + 16px); }

/* iOS 安全區底邊距補強（如果有需要） */
@supports(padding: max(0px)){
  .tabbar{ padding-bottom: max(env(safe-area-inset-bottom), 0px); }
}

/* ====== Appbar/速度區塊微調（避免頂部擠） ====== */
.appbar .row{ align-items: center; }
.speed{ white-space: nowrap; }  /* 避免 x0.75 被換行 */

/* === 列表型卡片（旅行會話＋歷史紀錄）統一修正 === */

/* 版面：左文字、右按鈕；窄螢幕按鈕自動換行，不遮字 */
.list .card{
  display:grid;
  grid-template-columns:minmax(0,1fr) auto;
  align-items:start;
  column-gap:12px;
}
.list .card .text{ min-width:0; }
.list .card .actions,
.list .card .badges{
  position:static !important;   /* 取消絕對定位，避免壓到文字 */
  display:flex;
  gap:8px;
  align-self:start;
}
@media (max-width:380px){
  .list .card{ grid-template-columns:1fr; }
  .list .card .actions,
  .list .card .badges{ margin-top:6px; }
}

/* 日文區塊（你的 DOM 用 .ko）：漂亮換行＋避免孤字行 */
.list .card .ko{
  /* 先解除舊的強迫斷字與寬度限制 */
  max-width:none !important;
  word-wrap:normal !important;
  overflow-wrap:normal !important;

  /* CJK 友善換行 */
  word-break:keep-all;
  line-break:strict;
  -webkit-line-break:strict;
  text-wrap:balance;            /* 新瀏覽器平均分行 */
  letter-spacing:.01em;
  line-height:1.75;

  /* 避免最後只剩 1 個字（瀏覽器盡力而為） */
  min-inline-size:6em;
  widows:2;
  orphans:2;

  /* 空間不足時用字距補齊，避免孤字行 */
  text-align:justify;
  text-justify:inter-character;
}

/* 英文／中文在兩頁面也一致處理 */
.list .card .en{
  overflow-wrap:anywhere;
  hyphens:auto;
  line-height:1.5;
}
.list .card .zh{
  word-break:keep-all;
  overflow-wrap:normal;
  line-break:strict;
  -webkit-line-break:strict;
  text-wrap:pretty;
  line-height:1.6;
}

/* 手機：再縮一點左右內距，給句子更多寬度 */
@media (max-width:420px){
  .list .card{ padding:12px 12px; }
}

/* === 修正：關掉日文強制對齊，避免大空白 === */
#cards .card .ko,
.list .card .ko{
  text-align: start !important;      /* 關掉 justify */
  text-justify: auto !important;
  letter-spacing: .01em;
  line-height: 1.75;
  text-wrap: balance;                 /* 仍保留平均分行 */
  word-break: keep-all;
  line-break: strict;
  -webkit-line-break: strict;

  /* 避免孤字行：保守一點，不要硬撐過頭 */
  min-inline-size: 5em;               /* 原先 6em → 稍微放鬆 */
  widows: 2;
  orphans: 2;
}

/* 若瀏覽器不支援 balance，退成 pretty */
@supports not (text-wrap: balance){
  #cards .card .ko,
  .list .card .ko{ text-wrap: pretty; }
}

/* 仍保證按鈕不會蓋字（保險再覆蓋一次） */
#cards .card .badges,
#cards .card .actions,
.list .card .badges,
.list .card .actions{
  position: static !important;
  display: flex;
  gap: 8px;
  align-self: start;
}

@media (max-width: 380px){
  #cards .card, .list .card{ grid-template-columns: 1fr; }
  #cards .card .badges, #cards .card .actions,
  .list .card .badges, .list .card .actions{ margin-top: 6px; }
}